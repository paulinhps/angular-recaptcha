<!DOCTYPE html>
<html lang="en">
    <head>
        <title>VividCortex reCaptcha Directive Example</title>

        <!-- Bootstrap is NOT required, it's just here to make the demo look better -->
        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" rel="stylesheet">

        <!-- Include AngularJS -->
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.28/angular.js"></script>
        <!-- Include the ngReCaptcha directive -->
        <script src="../release/angular-recaptcha.js"></script>

        <!-- define your app and make it depend on vcRecaptcha module -->
        <script>
            var app = angular.module('testApp', ['vcRecaptcha']);

            app.controller('testCtrl', function ($scope, vcRecaptchaService) {
                console.log("this is your app's controller");
                $scope.response = null;
                $scope.widgetId = null;
                $scope.configRequest = {
                    url: "./siteKey.json"
                }
                $scope.model = {
                    key: '6Lc9VuQUAAAAANZN735AqemoaegCmfNE82yOG07p'
                };

                $scope.getSiteKey = function (payload){
                    console.info("Loading http request siteKey")
                    console.log(this);
                    return payload.siteKey;
                }

                $scope.setResponse = function (response) {
                    console.info('Response available');

                    $scope.response = response;
                };

                $scope.setWidgetId = function (widgetId) {
                    console.info('Created widget ID: %s', widgetId);

                    $scope.widgetId = widgetId;
                };

                $scope.cbExpiration = function() {
                    console.info('Captcha expired. Resetting response object');

                    vcRecaptchaService.reload($scope.widgetId);

                    $scope.response = null;
                 };


                $scope.submit = function () {
                    var valid;

                    /**
                     * SERVER SIDE VALIDATION
                     *
                     * You need to implement your server side validation here.
                     * Send the reCaptcha response to the server and use some of the server side APIs to validate it
                     * See https://developers.google.com/recaptcha/docs/verify
                     */
                    var valid = $scope.MyForm.$valid;


                    console.log('sending the captcha response to the server', $scope.response);

                    if (valid) {
                        $scope.MyForm.$submitted = true;
                        console.log('Success');
                    } else {
                        console.log('Failed validation');

                        // In case of a failed validation you need to reload the captcha
                        // because each response can be checked just once
                        vcRecaptchaService.reload($scope.widgetId);
                    }
                };

                $scope.reload = function(){

                    $scope.MyForm.$setPristine();
                    $scope.MyForm.$submitted = false;

                    vcRecaptchaService.reload($scope.widgetId);
                }
            });
        </script>

    </head>
    <body ng-app="testApp">
    <div class="container"  ng-controller="testCtrl">

        <div class="row">
            <div class="col-md-12">
                <form id="MyForm" name="MyForm" ng-submit="submit()">
                    <legend>VividCortex reCaptcha Directive Example</legend>
                    <p>
                        This the <b>recommended</b> way of using the reCaptcha directive.
                        Instead of using ng-model to get the challenge and response, you use a service.
                        This way it's safer because we don't depend on a timeout hack that we are currently using in the directive.
                    </p>
                    <div class="form-group">
                        <div
                        vc-recaptcha
                        theme="'light'"
                        request-key="configRequest"
                        after-request-key="getSiteKey(payload)"                        
                        on-create="setWidgetId(widgetId)"
                        on-success="setResponse(response)"
                        on-expire="cbExpiration()"
                    ></div>
                    </div>

                    <div class="form-group">
                        <button type="button" class="btn btn-danger pull-left" ng-show="MyForm.$submitted" ng-click="reload()">Reset</button>
                        <button type="submit" class="btn btn-primary pull-right" ng-disabled="MyForm.$invalid || MyForm.$submitted">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    </body>
</html>
